name: Deploy to Local ResearchSpace (self-hosted)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    # Requires a self-hosted runner installed on your Windows machine
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Print context
        shell: powershell
        run: |
          Write-Host "Actor: $env:RUNNER_NAME on $env:RUNNER_OS"

      - name: Ensure runtime-data clone exists (self-healing)
        shell: powershell
        env:
          TARGET: C:\Users\matte\researchspace-docker-desktop-main\researchspace-docker-desktop-main\researchspace\runtime-data
          REPO: ${{ github.repository }}
          TOKEN: ${{ github.token }}
        run: |
          if (-not (Test-Path $env:TARGET)) {
            New-Item -ItemType Directory -Force -Path $env:TARGET | Out-Null
          }
          if (-not (Test-Path (Join-Path $env:TARGET '.git'))) {
            Write-Host "Cloning $env:REPO into $env:TARGET"
            Remove-Item -Path (Join-Path $env:TARGET '*') -Recurse -Force -ErrorAction SilentlyContinue
            git clone "https://x-access-token:$($env:TOKEN)@github.com/$($env:REPO).git" $env:TARGET
          }

      - name: Update runtime-data from origin/main
        shell: powershell
        run: |
          $target = 'C:\\Users\\matte\\researchspace-docker-desktop-main\\researchspace-docker-desktop-main\\researchspace\\runtime-data'
          $repo = '${{ github.repository }}'
          $token = '${{ github.token }}'
          git -C $target remote set-url origin "https://x-access-token:$token@github.com/$repo.git"
          git -C $target fetch origin
          git -C $target reset --hard origin/main

      - name: Sync repo config/data/ldp into runtime-data
        shell: powershell
        run: |
          $target = 'C:\\Users\\matte\\researchspace-docker-desktop-main\\researchspace-docker-desktop-main\\researchspace\\runtime-data'
          $src = "$env:GITHUB_WORKSPACE"
          Write-Host "Syncing from $src to $target"
          # Ensure target subfolders exist
          New-Item -ItemType Directory -Force -Path "$target\config" | Out-Null
          New-Item -ItemType Directory -Force -Path "$target\data" | Out-Null
          New-Item -ItemType Directory -Force -Path "$target\data\templates" | Out-Null
          New-Item -ItemType Directory -Force -Path "$target\ldp" | Out-Null

          # Copy config (non-destructive overwrite)
          if (Test-Path "$src\config") { Copy-Item "$src\config\*" "$target\config" -Recurse -Force }

          # Copy data (templates and others)
          if (Test-Path "$src\data") { Copy-Item "$src\data\*" "$target\data" -Recurse -Force }

          # Copy LDP configs
          if (Test-Path "$src\ldp") { Copy-Item "$src\ldp\*" "$target\ldp" -Recurse -Force }

          # Show that the specific template exists after sync
          $tpl = "$target\data\templates\http%3A%2F%2Fwww.researchspace.org%2Fresource%2FResourceContent.html"
          if (Test-Path $tpl) { Write-Host "Template synced: $tpl" } else { Write-Error "Template missing after sync: $tpl"; exit 1 }

      

      - name: Restart ResearchSpace service
        shell: powershell
        run: |
          $root = 'C:\\Users\\matte\\researchspace-docker-desktop-main\\researchspace-docker-desktop-main'
          Set-Location $root
          # Pull latest image(s); we intentionally do not build locally to always use the existing image
          docker compose pull researchspace
          docker compose ps researchspace
          # Recreate container to ensure new image is used
          docker compose up -d --no-deps --force-recreate researchspace

      - name: Show service status
        shell: powershell
        run: |
          $root = 'C:\\Users\\matte\\researchspace-docker-desktop-main\\researchspace-docker-desktop-main'
          Set-Location $root
          docker compose ps researchspace
          # Print the running image reference and digest for verification
          $cid = docker compose ps -q researchspace
          if ($cid) {
            $imgName = docker inspect -f "{{.Config.Image}}" $cid
            Write-Host "Running image: $imgName"
            try {
              $repoDigests = docker image inspect $imgName --format "{{json .RepoDigests}}"
              Write-Host "RepoDigests: $repoDigests"
            } catch {
              Write-Host "Could not retrieve image digests for $imgName"
            }
          } else {
            Write-Host "No container ID found for 'researchspace'"
          }
